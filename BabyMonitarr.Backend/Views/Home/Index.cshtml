@model BabyMonitarr.Backend.Models.AudioSettings

@{
    ViewData["Title"] = "BabyMonitarr - Audio Monitor Settings";
}

<div class="text-center">
    <h1 class="display-4">BabyMonitarr</h1>
    <p>Configure your baby monitor audio settings below.</p>
</div>

<div class="row">
    <div class="col-md-6 offset-md-3">
        <div class="card">
            <div class="card-header">
                <h4>Audio Monitor Settings</h4>
            </div>
            <div class="card-body">
                <form asp-action="UpdateSettings" method="post">
                    <h5 class="mb-3">Camera Settings</h5>
                    
                    <div class="form-group mb-3">
                        <label asp-for="CameraStreamUrl">Camera Stream URL</label>
                        <input asp-for="CameraStreamUrl" class="form-control" type="text" />
                        <small class="form-text text-muted">RTSP or HTTP URL to your security camera stream (e.g., rtsp://192.168.1.100:554/stream)</small>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input asp-for="UseCameraAudioStream" class="form-check-input" type="checkbox" />
                        <label asp-for="UseCameraAudioStream" class="form-check-label">Use Camera Audio Stream</label>
                        <small class="d-block form-text text-muted">Enable to use audio from camera instead of local microphone</small>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6">
                            <div class="form-group">
                                <label asp-for="CameraUsername">Camera Username</label>
                                <input asp-for="CameraUsername" class="form-control" type="text" />
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="form-group">
                                <label asp-for="CameraPassword">Camera Password</label>
                                <input asp-for="CameraPassword" class="form-control" type="password" />
                            </div>
                        </div>
                    </div>
                    
                    <hr class="my-4" />
                    
                    <h5 class="mb-3">Audio Detection Settings</h5>
                    <div class="form-group mb-3">
                        <label asp-for="SoundThreshold">Sound Threshold (dB)</label>
                        <input asp-for="SoundThreshold" class="form-control" type="number" step="0.5" />
                        <small class="form-text text-muted">Lower values are more sensitive (e.g., -40dB is more sensitive than -20dB)</small>
                    </div>

                    <div class="form-group mb-3">
                        <label asp-for="AverageSampleCount">Sample Count for Averaging</label>
                        <input asp-for="AverageSampleCount" class="form-control" type="number" min="1" max="100" />
                        <small class="form-text text-muted">Higher values make detection more stable but less responsive</small>
                    </div>

                    <div class="form-check mb-3">
                        <input asp-for="FilterEnabled" class="form-check-input" type="checkbox" />
                        <label asp-for="FilterEnabled" class="form-check-label">Enable Audio Filter</label>
                    </div>

                    <div class="form-group mb-3">
                        <label asp-for="LowPassFrequency">Low Pass Filter (Hz)</label>
                        <input asp-for="LowPassFrequency" class="form-control" type="number" min="200" max="20000" step="100" />
                        <small class="form-text text-muted">Frequencies below this value will pass through</small>
                    </div>

                    <div class="form-group mb-3">
                        <label asp-for="HighPassFrequency">High Pass Filter (Hz)</label>
                        <input asp-for="HighPassFrequency" class="form-control" type="number" min="20" max="2000" step="10" />
                        <small class="form-text text-muted">Frequencies above this value will pass through</small>
                    </div>

                    <div class="text-center">
                        <button type="submit" class="btn btn-primary">Save Settings</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-6 offset-md-3">
        <div class="card">
            <div class="card-header">
                <h4>Audio Monitor Status</h4>
            </div>
            <div class="card-body">
                <div id="audioLevel">
                    <div class="progress mb-3">
                        <div id="levelBar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                    <p>Current Level: <span id="currentLevel">N/A</span> dB</p>
                </div>
                <div class="text-center">
                    <button id="btnConnect" class="btn btn-success">Connect</button>
                    <button id="btnDisconnect" class="btn btn-danger d-none">Disconnect</button>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="~/js/signalr/dist/browser/signalr.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Connect and disconnect buttons
            const btnConnect = document.getElementById('btnConnect');
            const btnDisconnect = document.getElementById('btnDisconnect');
            
            // Audio level display elements
            const levelBar = document.getElementById('levelBar');
            const currentLevel = document.getElementById('currentLevel');
            
            // Create SignalR connection
            const connection = new signalR.HubConnectionBuilder()
                .withUrl("/audioHub")
                .withAutomaticReconnect()
                .build();
                
            // Handle received audio data
            connection.on("ReceiveAudioData", function (audioBase64, level, timestamp) {
                // Update audio level display
                const normalizedLevel = Math.max(0, Math.min(100, (level + 60) / 60 * 100));
                levelBar.style.width = normalizedLevel + "%";
                currentLevel.textContent = level.toFixed(1);
                
                // Set color based on threshold
                if (level > @Model.SoundThreshold) {
                    levelBar.classList.remove('bg-info');
                    levelBar.classList.add('bg-danger');
                } else {
                    levelBar.classList.remove('bg-danger');
                    levelBar.classList.add('bg-info');
                }
            });
            
            // Handle sound alerts
            connection.on("SoundAlert", function (level, threshold, timestamp) {
                // Display alert
                const alertTime = new Date(timestamp);
                const alertMessage = `Sound alert at ${alertTime.toLocaleTimeString()}! Level: ${level.toFixed(1)} dB`;
                
                // Create an alert element and add it to the page
                const alertDiv = document.createElement('div');
                alertDiv.className = 'alert alert-warning alert-dismissible fade show';
                alertDiv.innerHTML = `
                    <strong>Alert!</strong> ${alertMessage}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                `;
                
                // Add to the page
                document.querySelector('.row:first-child').prepend(alertDiv);
                
                // Auto-dismiss after 10 seconds
                setTimeout(() => {
                    alertDiv.classList.remove('show');
                    setTimeout(() => alertDiv.remove(), 1000);
                }, 10000);
            });
            
            // Connect button event
            btnConnect.addEventListener('click', async function () {
                try {
                    await connection.start();
                    console.log("SignalR Connected.");
                    
                    // Start audio stream
                    await connection.invoke("StartStream");
                    
                    // Update UI
                    btnConnect.classList.add('d-none');
                    btnDisconnect.classList.remove('d-none');
                } catch (err) {
                    console.error(err);
                    alert("Connection failed: " + err);
                }
            });
            
            // Disconnect button event
            btnDisconnect.addEventListener('click', async function () {
                try {
                    // Stop audio stream
                    await connection.invoke("StopStream");
                    
                    // Stop connection
                    await connection.stop();
                    console.log("SignalR Disconnected.");
                    
                    // Update UI
                    btnDisconnect.classList.add('d-none');
                    btnConnect.classList.remove('d-none');
                    
                    // Reset level display
                    levelBar.style.width = "0%";
                    currentLevel.textContent = "N/A";
                } catch (err) {
                    console.error(err);
                    alert("Disconnection failed: " + err);
                }
            });
            
            // Handle connection closed
            connection.onclose(async () => {
                btnDisconnect.classList.add('d-none');
                btnConnect.classList.remove('d-none');
                console.log("SignalR Connection closed.");
            });
        });
    </script>
}